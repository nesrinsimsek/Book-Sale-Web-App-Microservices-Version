@model BookSale.MVC.Models.Dtos.LoginRequestDto

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Giriş Yap</title>

    <!-- Font Icon -->
    <link rel="stylesheet" href="~/registerUI/fonts/material-icon/css/material-design-iconic-font.min.css">

    <!-- Main css -->
    <link rel="stylesheet" href="~/registerUI/css/style.css">
</head>
<body>

    <div class="main">

        <!-- Sign in  Form -->
        <section class="sign-in">
            <div class="container">
                <div class="signin-content">
                    <div class="signin-image">
                        <figure><img src="~/registerUI/images/signin-image.jpg" alt="sing up image"></figure>
                    </div>

                    <div class="signin-form">
                        <h2 class="form-title">Giriş yap</h2>
                        <form method="POST" class="register-form" id="login-form">
                            <div class="form-group">
                                <span asp-validation-for="Email"></span>
                                <label asp-for="Email"><i class="zmdi zmdi-account material-icons-name"></i></label>
                                <input asp-for="Email" type="email" name="Email" id="email" placeholder="Email" />
                            </div>
                            <div class="form-group">
                                <span asp-validation-for="Password"></span>
                                <label asp-for="Password"><i class="zmdi zmdi-lock"></i></label>
                                <input asp-for="Password" type="password" name="Password" id="pass" placeholder="Şifre" />
                            </div>
                            <div class="form-group form-button">
                                <input type="submit" name="signin" id="signin" class="form-submit" value="Giriş Yap" />
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- JS -->
    <script src="~/vendor/jquery/jquery.min.js"></script>
    <script src="~/registerUI/js/main.js"></script>

    @section Scripts {
        <script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
        <script type="text/javascript">


            var connection = new signalR.HubConnectionBuilder().withUrl("https://localhost:7058/AuthenticationHub").build();

            connection.start()
                .then(() => {
                    console.log("Bağlantı başarılı bir şekilde kuruldu.");

                })
                .catch((err) => {
                    console.log("Bağlantı kurulurken bir hata oluştu:", err);
                });


            connection.on("ForceLogout", () => {
                console.log("Başka bir browserda zaten oturum açılmış.");

                fetch("/Auth/Logout", {
                    method: "GET"
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Oturum sonlandırma isteği başarısız oldu.");
                        }
                        console.log("Oturum başarıyla sonlandırıldı.");
                    })
                    .catch(error => {
                        console.error("Oturum sonlandırma hatası:", error);
                    });
            });




            /** HandleForceLogout çalışıyor ama user id null geliyor **/

            // document.addEventListener("DOMContentLoaded", function () {
            //     document.getElementById("login-form").addEventListener("submit", function (event) {
            //         event.preventDefault(); // Formun varsayılan submit işlemini engelle

            //         // Formdaki email ve şifre değerlerini al
            //         var email = document.getElementById("email").value;
            //         var password = document.getElementById("pass").value;

            //         // Fetch API kullanarak giriş isteği gönder
            //         fetch('/Auth/Login', {
            //             method: 'POST',
            //             headers: {
            //                 'Content-Type': 'application/json'
            //             },
            //             body: JSON.stringify({
            //                 Email: email,
            //                 Password: password
            //             })
            //         })
            //             .then(function (response) {
            //                 if (!response.ok) {
            //                     throw new Error('Network response was not ok');
            //                 }
            //             
            //                 connection.invoke("HandleForceLogout");
            //             })
            //             .catch(function (error) {
            //                 console.error('There has been a problem with your fetch operation:', error);
            //             });
            //     });
            // });






            // $(document).ready(function () {
            //     // Form submit olayını dinle
            //     $("#login-form").submit(function (event) {
            
            //         // Formun default davranışını engelle
            //         event.preventDefault();

            //         // HandleForceLogout metodunu çağır
            //         connection.invoke("HandleForceLogout"); // bu tüm browserlerda çalışıyor ama submit gerçekleşmeden çalıştığı için Hub'da user id null geliyor


            //         setTimeout(function () { // bir kez çalışıyor diğerlerinde çalışmıyor. submiti bekleyip çalıştığından user id doğru geliyor
            //             connection.invoke("HandleForceLogout");
            //         }, 500); // 500 milisaniye gecikme ekledik


            //         // Formu gönder
            //         this.submit();

            //     });
            // });




        </script>
    }

</body>
